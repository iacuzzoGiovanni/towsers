// Generated by CoffeeScript 1.11.1

/*
 * Created by Iacuzzo Giovanni
 */
(function() {
  'use-strict';

  /*
   * @module {custoWavesurfer}
   */
  var cWavesurfer;
  cWavesurfer = angular.module('custoWavesurfer', []);
  cWavesurfer.factory('mdWavesurferUtils', [
    '$q', '$document', '$timeout', function($q, $document, $timeout) {
      return {
        getLength: function(object) {
          var deferred, estimateLength;
          deferred = $q.defer();
          estimateLength = function(url) {
            var audio;
            audio = $document[0].createElement('audio');
            audio.src = url;
            audio.addEventListener('loadeddata', function() {
              deferred.resolve(this.duration);
              audio.removeEventListener('loadeddata', this);
              audio.src = 'data:audio/mpeg,0';
            });
            audio.addEventListener('error', function(e) {
              deferred.resolve(e.target.error);
            });
          };
          estimateLength(object);
          return deferred.promise;
        }
      };
    }
  ]);
  cWavesurfer.filter('convertToHumanMinutes', function() {
    return function(d) {
      var dur, mm, ss;
      mm = Math.floor(d / 60);
      ss = Math.round(d % 60);
      if (ss < 10) {
        ss = '0' + ss;
      }
      return dur = mm + ':' + ss;
    };
  });
  cWavesurfer.controller('musicAudioPlayerController', [
    '$attrs', '$element', '$scope', '$interval', '$location', '$rootScope', '$routeParams', function(attributes, $element, $scope, $interval, $location, $rootScope, $routeParams) {
      var audio;
      audio = this;
      audio.tracks = [];
      audio.currentTrack = null;
      audio.track;
      audio.currentTrackDuration;
      audio.currentTimeTrackDuration;
      audio.currentTrackArtist;
      audio.currentTrackTitle;
      audio.currentTrackCover;
      audio.paused = true;
      audio.progressBar;
      $rootScope.$on('$routeChangeStart', function(e, current, pre) {
        if ($location.path() !== '/music') {
          audio.track.src = 'data:audio/mpeg,0';
          audio.track.removeEventListener('timeupdate', audio.getCurrentTimeTrack);
        }
      });
      audio.addTrack = function(trackScope) {
        if (audio.tracks.indexOf(trackScope) < 0) {
          return audio.tracks.push(trackScope);
        }
      };
      audio.setTrack = function(t) {
        if (audio.track) {
          audio.track.src = 'data:audio/mpeg,0';
          audio.track.removeEventListener('timeupdate', audio.getCurrentTimeTrack);
        }
        audio.track = new Audio(audio.tracks[t].url);
        audio.currentTrackDuration = audio.tracks[t].duration;
        audio.currentTrackArtist = audio.tracks[t].artist;
        audio.currentTrackTitle = audio.tracks[t].title;
        audio.currentTrackCover = audio.tracks[t].cover;
        audio.startInterval();
        return audio.setCurrentTrack(t);
      };
      audio.setCurrentTrack = function(ct) {
        return audio.currentTrack = ct;
      };
      audio.getCurrentTrack = function() {
        return audio.currentTrack;
      };
      audio.addFromPlaylist = function(e) {
        var idx;
        e.preventDefault();
        idx = e.target.getAttribute('data-index');
        audio.setTrack(idx);
        return audio.play();
      };
      audio.play = function() {
        if (audio.getCurrentTrack() === null) {
          audio.setTrack(0);
          audio.track.play();
          return audio.paused = false;
        } else {
          if (audio.track.paused) {
            audio.track.play();
            audio.startInterval();
            return audio.paused = false;
          } else {
            audio.track.pause();
            audio.track.removeEventListener('timeupdate', audio.getCurrentTimeTrack);
            return audio.paused = true;
          }
        }
      };
      audio.backward = function(e) {
        if (audio.getCurrentTrack() === null) {
          audio.setTrack(0);
          audio.track.play();
          return audio.paused = false;
        } else {
          if (audio.currentTrack - 1 < 0) {
            audio.setTrack(audio.tracks.length - 1);
            return audio.track.play();
          } else {
            audio.setTrack(audio.currentTrack - 1);
            return audio.track.play();
          }
        }
      };
      audio.forward = function(e) {
        if (audio.getCurrentTrack() === null) {
          audio.setTrack(0);
          audio.track.play();
          return audio.paused = false;
        } else {
          if (audio.currentTrack + 1 <= audio.tracks.length - 1) {
            audio.setTrack(audio.currentTrack + 1);
            return audio.track.play();
          } else {
            audio.setTrack(0);
            return audio.track.play();
          }
        }
      };
      audio.convertToHumanMinutes = function(d) {
        var dur, mm, ss;
        mm = Math.floor(d / 60);
        ss = Math.round(d % 60);
        if (ss < 10) {
          ss = '0' + ss;
        }
        return dur = mm + ':' + ss;
      };
      audio.startInterval = function() {
        if (audio.track) {
          return audio.track.addEventListener('timeupdate', audio.getCurrentTimeTrack, false);
        }
      };
      audio.getCurrentTimeTrack = function() {
        audio.currentTimeTrackDuration = this.currentTime;
        audio.setProgressBarPosition();
        return $scope.$digest();
      };
      audio.setProgressBarPosition = function() {
        var barInner, dragger, oWidth, position;
        position = (audio.currentTimeTrackDuration / audio.currentTrackDuration) * 100;
        oWidth = audio.progressBar[0].querySelector('#progressBar').offsetWidth;
        dragger = audio.progressBar[0].querySelector('#position');
        barInner = audio.progressBar[0].querySelector('#bar-inner');
        dragger.style.left = oWidth / 100 * position - dragger.offsetWidth + 'px';
        return barInner.style.width = oWidth / 100 * position + 'px';
      };
      audio.setTrackPosition = function(e, down, rangeLeft, rangeWidth, dragger, draggerWidth, barInner) {
        var position;
        position = audio.currentTrackDuration * ((e.pageX - rangeLeft) / rangeWidth);
        audio.track.currentTime = position;
        audio.currentTimeTrackDuration = position;
        return $scope.$digest();
      };
      audio.updateDragger = function(e, down, rangeLeft, rangeWidth, dragger, draggerWidth, barInner) {
        if (down && e.pageX >= rangeLeft && e.pageX <= rangeLeft + rangeWidth) {
          dragger.style.left = e.pageX - rangeLeft - draggerWidth + 'px';
          barInner.style.width = e.pageX - rangeLeft + 'px';
        }
      };
      audio.onSlide = function(el) {
        var barInner, down, dragger, draggerWidth, range, rangeLeft, rangeParent, rangeWidth;
        range = el[0].querySelector('#progressBar');
        rangeParent = el.parent()[0];
        dragger = range.querySelector('#position');
        barInner = range.querySelector('#bar-inner');
        draggerWidth = 16;
        down = false;
        rangeWidth = range.offsetWidth;
        rangeLeft = range.offsetLeft + rangeParent.offsetLeft;
        dragger.style.width = draggerWidth + 'px';
        dragger.style.left = -draggerWidth + 'px';
        dragger.style.marginLeft = draggerWidth / 2 + 'px';
        range.addEventListener('mousedown', function(e) {
          if (e.which === 1 && audio.track) {
            audio.updateDragger(e, down, rangeLeft, rangeWidth, dragger, draggerWidth, barInner);
            audio.track.removeEventListener('timeupdate', audio.getCurrentTimeTrack);
            down = true;
            return false;
          }
        });
        document.addEventListener('mousemove', function(e) {
          audio.updateDragger(e, down, rangeLeft, rangeWidth, dragger, draggerWidth, barInner);
        });
        return document.addEventListener('mouseup', function(e) {
          if (audio.track && down === true) {
            audio.startInterval();
            audio.setTrackPosition(e, down, rangeLeft, rangeWidth, dragger, draggerWidth, barInner);
          }
          down = false;
        });
      };
    }
  ]);
  cWavesurfer.directive('player', function() {
    return {
      restrict: 'E',
      templateUrl: myLocalized.partials + 'custom-player.html',
      controller: 'musicAudioPlayerController',
      controllerAs: 'audio'
    };
  });
  cWavesurfer.directive('customAudioSource', [
    'mdWavesurferUtils', function(mdWavesurferUtils) {
      return {
        restrict: 'E',
        require: '^player',
        scope: {
          url: '@',
          title: '@',
          artist: '@',
          cover: '@'
        },
        link: function(scope, element, attrs, audio) {
          var thepromise;
          audio.addTrack(scope);
          thepromise = mdWavesurferUtils.getLength(scope.url);
          return thepromise.then((function(duration) {
            scope.duration = duration;
          }), function(reason) {});
        }
      };
    }
  ]);
  cWavesurfer.directive('playerProgressBar', [
    function() {
      return {
        restrict: 'E',
        templateUrl: myLocalized.partials + 'player-progress-bar.html',
        require: '^player',
        link: function(scope, element, attrs, audio) {
          audio.progressBar = element;
          audio.onSlide(audio.progressBar);
        }
      };
    }
  ]);
})();
